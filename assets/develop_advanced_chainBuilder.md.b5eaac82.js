import{_ as a,o as n,c as l,S as o}from"./chunks/framework.2ada2e54.js";const i=JSON.parse('{"title":"介入 Chain 构建媒体消息时的操作","description":"","frontmatter":{},"headers":[],"relativePath":"develop/advanced/chainBuilder.md","filePath":"develop/advanced/chainBuilder.md","lastUpdated":1752828192000}'),p={name:"develop/advanced/chainBuilder.md"};function e(t,s,c,r,y,D){return n(),l("div",null,s[0]||(s[0]=[o(`<h1 id="介入-chain-构建媒体消息时的操作" tabindex="-1">介入 Chain 构建媒体消息时的操作 <a class="header-anchor" href="#介入-chain-构建媒体消息时的操作" aria-label="Permalink to &quot;介入 Chain 构建媒体消息时的操作&quot;">​</a></h1><p>Chain 对象在构建消息时，可使用辅助类介入媒体消息或浏览器的构建过程。</p><h2 id="创建辅助类" tabindex="-1">创建辅助类 <a class="header-anchor" href="#创建辅助类" aria-label="Permalink to &quot;创建辅助类&quot;">​</a></h2><p>继承 <code>ChainBuilder</code> 类并覆写其方法创建一个自定义的辅助类。在实例化 Chain 时，传入辅助类实例即可介入 Chain 的操作。</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> typing </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Union</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> amiyabot </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Chain</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ChainBuilder</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> playwright</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">async_api </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Page</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">MyBuilder</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">ChainBuilder</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">classmethod</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">get_image</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">cls</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">image</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">bytes</span><span style="color:#89DDFF;">])</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;"> Union</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">bytes</span><span style="color:#89DDFF;">]:</span></span>
<span class="line"><span style="color:#BABED8;">        ...</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">classmethod</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">get_voice</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">cls</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">voice_file</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">        ...</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> voice_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">classmethod</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">get_video</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">cls</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">video_file</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">        ...</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> video_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">classmethod</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">on_page_rendered</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">cls</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">page</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Page</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">        ...</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 在构造参数里使用辅助类</span></span>
<span class="line"><span style="color:#BABED8;">chain </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Chain</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">...</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#BABED8;font-style:italic;">chain_builder</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">MyBuilder</span><span style="color:#89DDFF;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 为属性赋值使用辅助类</span></span>
<span class="line"><span style="color:#BABED8;">chain</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">builder</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">MyBuilder</span><span style="color:#89DDFF;">()</span></span></code></pre></div><h2 id="get-image" tabindex="-1">get_image <a class="header-anchor" href="#get-image" aria-label="Permalink to &quot;get_image&quot;">​</a></h2><p>该函数会在 chain 构建图片消息时调用，每张图片调用一次。传入一个参数 <code>image</code> ，类型为 <code>str</code>（文件路径或 url） 或 <code>bytes</code>（图片字节数据）。<br> 如果函数有返回值（必须是以上两种类型），chain 会使用返回值构建图片消息。</p><h2 id="get-voice" tabindex="-1">get_voice <a class="header-anchor" href="#get-voice" aria-label="Permalink to &quot;get_voice&quot;">​</a></h2><p>该函数会在 chain 构建语音消息时调用，每个语音文件调用一次。传入文件路径 <code>voice_file</code>。<br> 如果函数有返回值，chain 会使用返回值构建语音消息。</p><h2 id="get-video" tabindex="-1">get_video <a class="header-anchor" href="#get-video" aria-label="Permalink to &quot;get_video&quot;">​</a></h2><p>该函数会在 chain 构建视频消息时调用，每个视频文件调用一次。传入文件路径 <code>video_file</code>。<br> 如果函数有返回值，chain 会使用返回值构建视频消息。</p><h2 id="on-page-rendered" tabindex="-1">on_page_rendered <a class="header-anchor" href="#on-page-rendered" aria-label="Permalink to &quot;on_page_rendered&quot;">​</a></h2><p>该函数会在 chain 构建浏览器渲染的图片并打开了页面时调用，提供了浏览器的 <code>Page</code> 对象，可在此对 <code>Page</code> 进行操作（如对页面进行 JS 注入等）。</p><div class="tip custom-block"><p class="custom-block-title">提示</p><p>构建浏览器渲染的图片同样也会调用一次 <code>get_image</code> 函数。</p></div><p><strong>使用示例</strong></p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">BaiduSearch</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">ChainBuilder</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">classmethod</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">on_page_rendered</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">cls</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">page</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Page</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        可以在截图前先对页面进行操作，比如 ”百度一下“</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#BABED8;"> page</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">locator</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">#kw</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">fill</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">AmiyaBot</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#BABED8;"> page</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">locator</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">#su</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">click</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#BABED8;"> asyncio</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">bot</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on_message</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">keywords</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">def</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Message</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#BABED8;">    chain </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Chain</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#BABED8;font-style:italic;">chain_builder</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">BaiduSearch</span><span style="color:#89DDFF;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> chain</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">html</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://www.baidu.com/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#BABED8;font-style:italic;">is_template</span><span style="color:#89DDFF;">=False,</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#BABED8;font-style:italic;">render_time</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1000</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">)</span></span></code></pre></div>`,16)]))}const B=a(p,[["render",e]]);export{i as __pageData,B as default};
